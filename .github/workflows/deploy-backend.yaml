name: Build → Staging → Production

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yaml'
  workflow_dispatch:

env:
  PROJECT_ID: hit8-poc
  REGION: europe-west1
  # Base name for the image (without tag)
  IMAGE_BASE: europe-west1-docker.pkg.dev/hit8-poc/backend/api

jobs:
  # --------------------------------------------------------------------------
  # 1. BUILD: Build Docker Image Once & Push
  # --------------------------------------------------------------------------
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # Determine version/tag (SHA + VERSION file fallback)
      - name: Determine Tag
        id: meta
        run: |
          set -e
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '[:space:]')
            if [ -z "$VERSION" ]; then
              echo "Error: VERSION file is empty"
              exit 1
            fi
          else
            echo "Error: VERSION file is required but not found"
            exit 1
          fi
          # Create a unique, traceable tag: version-sha
          IMAGE_TAG="${VERSION}-${SHORT_SHA}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Push
        run: |
          set -e
          FULL_IMAGE="${{ env.IMAGE_BASE }}:${{ steps.meta.outputs.image_tag }}"
          VERSION="${{ steps.meta.outputs.version }}"
          
          # Build from backend directory (correct context)
          docker build \
            --tag "$FULL_IMAGE" \
            --build-arg VERSION="$VERSION" \
            ./backend
          
          # Push to Registry
          docker push "$FULL_IMAGE"
          
          # Verify image exists
          echo "Verifying image push..."
          gcloud container images describe "$FULL_IMAGE" --format="value(image_summary.fully_qualified_digest)"

  # --------------------------------------------------------------------------
  # 2. STAGING: Auto-Deploy
  # --------------------------------------------------------------------------
  deploy-staging:
    name: Deploy Staging
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Staging Services
        run: |
          set -e
          IMAGE="${{ env.IMAGE_BASE }}:${{ needs.build.outputs.image_tag }}"
          
          echo "Deploying Staging..."
          gcloud run services update hit8-api-stg \
            --image "$IMAGE" \
            --region ${{ env.REGION }} \
            --quiet
          
          # Verify deployment
          echo "Verifying staging deployment..."
          gcloud run services describe hit8-api-stg \
            --region ${{ env.REGION }} \
            --format="value(status.url)"

          # Optional: Update Job if needed
          # gcloud run jobs update hit8-report-job-stg --image "$IMAGE" ...

  # --------------------------------------------------------------------------
  # 3. PRODUCTION: Manual Approval (Gate)
  # --------------------------------------------------------------------------
  deploy-production:
    name: Deploy Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production # <--- Triggers Manual Approval in GitHub UI
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Production Services
        run: |
          set -e
          # REUSE EXACT SAME IMAGE
          IMAGE="${{ env.IMAGE_BASE }}:${{ needs.build.outputs.image_tag }}"
          
          echo "Deploying Production..."
          gcloud run services update hit8-api-prd \
            --image "$IMAGE" \
            --region ${{ env.REGION }} \
            --quiet
          
          # Verify deployment
          echo "Verifying production deployment..."
          gcloud run services describe hit8-api-prd \
            --region ${{ env.REGION }} \
            --format="value(status.url)"
