name: Build & Deploy

on:
  push:
    branches: [main]
    paths: ['apps/**', 'packages/**', '.github/workflows/**', 'VERSION']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------------
  # PATH FILTER (for conditional builds)
  # --------------------------------------------------------------------------
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      site: ${{ steps.filter.outputs.site }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/api/**'
              - 'backend/**'
              - '.github/workflows/deploy.yaml'
              - 'VERSION'
            frontend:
              - 'apps/web/**'
              - 'packages/**'
              - '.github/**'
            site:
              - 'apps/site/**'
              - '.github/**'

  # --------------------------------------------------------------------------
  # BUILD (three independent jobs)
  # --------------------------------------------------------------------------
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - run: gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Login to Scaleway
        run: echo "${{ secrets.SCW_SECRET_KEY }}" | docker login rg.fr-par.scw.cloud/hit8-registry -u nologin --password-stdin

      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          platforms: linux/amd64
          tags: |
            europe-west1-docker.pkg.dev/hit8-poc/backend/api:${{ steps.meta.outputs.tag }}
            europe-west1-docker.pkg.dev/hit8-poc/backend/api:${{ steps.meta.outputs.version }}
            rg.fr-par.scw.cloud/hit8-registry/api:${{ steps.meta.outputs.tag }}
            rg.fr-par.scw.cloud/hit8-registry/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build frontends
        run: |
          set -e
          VITE_API_URL=https://api-stg.hit8.io pnpm turbo build --filter=hit8-frontend
          mv apps/web/dist dist-stg
          VITE_API_URL=https://api-prd.hit8.io pnpm turbo build --filter=hit8-frontend
          mv apps/web/dist dist-prd
          VITE_API_URL=https://scw-prd.hit8.io pnpm turbo build --filter=hit8-frontend
          mv apps/web/dist dist-scw
        env:
          VITE_GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          VITE_GOOGLE_IDENTITY_PLATFORM_KEY: ${{ secrets.GOOGLE_IDENTITY_PLATFORM_KEY }}
          VITE_GOOGLE_IDENTITY_PLATFORM_DOMAIN: ${{ secrets.GOOGLE_IDENTITY_PLATFORM_DOMAIN }}
          VITE_API_TOKEN: ${{ secrets.API_TOKEN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - uses: actions/upload-artifact@v4
        with:
          name: frontends
          path: |
            dist-stg/
            dist-prd/
            dist-scw/
          retention-days: 1

  build-site:
    name: Build Site
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.site == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: |
          set -e
          pnpm turbo build --filter=site
          if [ ! -d "apps/site/dist" ]; then
            echo "Error: apps/site/dist directory not found after build"
            ls -la apps/site/
            exit 1
          fi
          mv apps/site/dist dist-site
          echo "Built site to dist-site directory"
          ls -la dist-site/ | head -20

      - uses: actions/upload-artifact@v4
        with:
          name: dist-site
          path: dist-site
          retention-days: 1

  # --------------------------------------------------------------------------
  # DEPLOY STAGING (Parallel)
  # --------------------------------------------------------------------------
  deploy-staging:
    name: Deploy Staging (${{ matrix.cloud }})
    needs: [build-backend]
    if: needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    environment: staging
    strategy:
      matrix:
        cloud: [gcp, scw]
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-backend
        with:
          cloud: ${{ matrix.cloud }}
          environment: staging
          image_tag: ${{ needs.build-backend.outputs.image_tag }}
          gcp_sa_key: ${{ secrets.GCP_SA_KEY }}
          gcp_project_id: ${{ secrets.GCP_PROJECT }}
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_project_id: ${{ secrets.SCW_PROJECT_ID }}
          scw_organization_id: ${{ secrets.SCW_ORGANIZATION_ID }}

  deploy-frontend-staging:
    name: Deploy Frontend (Staging)
    needs: [build-frontend, deploy-staging]
    if: needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontends

      - name: Install pnpm
        run: npm install -g pnpm

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-stg --project-name=hit8 --branch=main-staging

  deploy-site-staging:
    name: Deploy Site (Staging)
    needs: [build-site]
    if: needs.build-site.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist-site
          path: dist-site

      - name: Verify dist-site exists
        run: |
          if [ ! -d "dist-site" ]; then
            echo "Error: dist-site directory not found"
            ls -la
            exit 1
          fi
          echo "Found dist-site directory with $(find dist-site -type f | wc -l) files"

      - name: Install pnpm
        run: npm install -g pnpm

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-site --project-name=hit8-site --branch=main-staging

  # --------------------------------------------------------------------------
  # DEPLOY PRODUCTION (Manual Approval)
  # --------------------------------------------------------------------------
  deploy-production:
    name: Deploy Production (${{ matrix.cloud }})
    needs: [build-backend, deploy-staging, deploy-frontend-staging]
    if: needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        cloud: [gcp, scw]
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-backend
        with:
          cloud: ${{ matrix.cloud }}
          environment: production
          image_tag: ${{ needs.build-backend.outputs.image_tag }}
          gcp_sa_key: ${{ secrets.GCP_SA_KEY }}
          gcp_project_id: ${{ secrets.GCP_PROJECT }}
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_project_id: ${{ secrets.SCW_PROJECT_ID }}
          scw_organization_id: ${{ secrets.SCW_ORGANIZATION_ID }}

  deploy-frontend-production:
    name: Deploy Frontend (Production)
    needs: [build-frontend, deploy-production]
    if: needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontends

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Deploy iter8.hit8.io
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-prd --project-name=hit8 --branch=main --commit-dirty=true

      - name: Deploy scw.hit8.io
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-scw --project-name=hit8 --branch=scaleway --commit-dirty=true

  deploy-site-production:
    name: Deploy Site (Production)
    needs: [build-site, deploy-site-staging]
    if: needs.build-site.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist-site
          path: dist-site

      - name: Verify dist-site exists
        run: |
          if [ ! -d "dist-site" ]; then
            echo "Error: dist-site directory not found"
            ls -la
            exit 1
          fi
          echo "Found dist-site directory with $(find dist-site -type f | wc -l) files"

      - name: Install pnpm
        run: npm install -g pnpm

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-site --project-name=hit8-site --branch=main --commit-dirty=true

  # --------------------------------------------------------------------------
  # NOTIFY
  # --------------------------------------------------------------------------
  notify:
    name: Notify Deployment
    needs: [deploy-production, deploy-frontend-production, deploy-site-production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          B="${{ needs.deploy-production.result }}"
          F="${{ needs.deploy-frontend-production.result }}"
          S="${{ needs.deploy-site-production.result }}"
          if [ "$B" = "failure" ] || [ "$F" = "failure" ] || [ "$S" = "failure" ]; then
            echo "❌ Deployment failed"
            echo "  Backend: $B | Frontend: $F | Site: $S"
            exit 1
          fi
          echo "✅ Production deployment ok (backend=$B frontend=$F site=$S)"
