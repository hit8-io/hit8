name: Build & Deploy

on:
  push:
    branches: [main]
    paths: ['apps/web/**', 'apps/api/**', 'packages/**', 'infra/**', '.github/workflows/deploy.yaml', 'VERSION']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------------
  # PATH FILTER + BACKEND PROVIDER (single provider: gcp or scw)
  # --------------------------------------------------------------------------
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/api/**'
              - 'backend/**'
              - 'infra/backend-provider.txt'
              - '.github/workflows/deploy.yaml'
              - 'VERSION'
            frontend:
              - 'apps/web/**'
              - 'packages/**'
              - 'infra/backend-provider.txt'
              - '.github/workflows/deploy.yaml'

  provider:
    name: Backend provider
    runs-on: ubuntu-latest
    outputs:
      backend_provider: ${{ steps.read.outputs.backend_provider }}
      backend_provider_matrix: ${{ steps.read.outputs.backend_provider_matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: read
        run: |
          # Read default from variable "backend_provider" in variables.tf
          P=$(sed -n '/variable "backend_provider"/,/^}/p' infra/variables.tf | grep -oE '"(gcp|scw)"' | head -1 | tr -d '"')
          if [ "$P" != "gcp" ] && [ "$P" != "scw" ]; then
            echo "Could not parse backend_provider default from infra/variables.tf (got: $P)"
            exit 1
          fi
          echo "backend_provider=$P" >> $GITHUB_OUTPUT
          echo "backend_provider_matrix=[\"$P\"]" >> $GITHUB_OUTPUT
          echo "Using backend provider: $P (from variables.tf)"

  # --------------------------------------------------------------------------
  # BUILD (only for selected provider)
  # --------------------------------------------------------------------------
  build-backend:
    name: Build Backend (${{ needs.provider.outputs.backend_provider }})
    runs-on: ubuntu-latest
    needs: [changes, provider]
    if: (needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Auth and tags for selected provider
        id: provider
        run: |
          P="${{ needs.provider.outputs.backend_provider }}"
          TAG="${{ steps.meta.outputs.tag }}"
          VER="${{ steps.meta.outputs.version }}"
          if [ "$P" = "gcp" ]; then
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "europe-west1-docker.pkg.dev/hit8-poc/backend/api:${TAG}" >> $GITHUB_OUTPUT
            echo "europe-west1-docker.pkg.dev/hit8-poc/backend/api:${VER}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "rg.fr-par.scw.cloud/hit8-registry/api:${TAG}" >> $GITHUB_OUTPUT
            echo "rg.fr-par.scw.cloud/hit8-registry/api:latest" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - uses: google-github-actions/auth@v2
        if: needs.provider.outputs.backend_provider == 'gcp'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - run: gcloud auth configure-docker europe-west1-docker.pkg.dev
        if: needs.provider.outputs.backend_provider == 'gcp'

      - name: Login to Scaleway
        if: needs.provider.outputs.backend_provider == 'scw'
        run: echo "${{ secrets.SCW_SECRET_KEY }}" | docker login rg.fr-par.scw.cloud/hit8-registry -u nologin --password-stdin

      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          platforms: linux/amd64
          tags: ${{ steps.provider.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    name: Build Frontend (${{ needs.provider.outputs.backend_provider }})
    runs-on: ubuntu-latest
    needs: [changes, provider]
    if: (needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build frontends (stg + prd for selected provider)
        run: |
          set -e
          P="${{ needs.provider.outputs.backend_provider }}"
          if [ "$P" = "gcp" ]; then
            STG_URL="https://api-stg.hit8.io"
            PRD_URL="https://api-prd.hit8.io"
          else
            STG_URL="https://scw-stg.hit8.io"
            PRD_URL="https://scw-prd.hit8.io"
          fi
          VITE_API_URL="$STG_URL" pnpm turbo build --filter=hit8-frontend
          mv apps/web/dist dist-stg
          VITE_API_URL="$PRD_URL" pnpm turbo build --filter=hit8-frontend
          mv apps/web/dist dist-prd
        env:
          VITE_GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          VITE_GOOGLE_IDENTITY_PLATFORM_KEY: ${{ secrets.GOOGLE_IDENTITY_PLATFORM_KEY }}
          VITE_GOOGLE_IDENTITY_PLATFORM_DOMAIN: ${{ secrets.GOOGLE_IDENTITY_PLATFORM_DOMAIN }}
          VITE_API_TOKEN: ${{ secrets.API_TOKEN }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - uses: actions/upload-artifact@v4
        with:
          name: frontends
          path: |
            dist-stg/
            dist-prd/
          retention-days: 1

  # --------------------------------------------------------------------------
  # DEPLOY STAGING (Parallel)
  # --------------------------------------------------------------------------
  deploy-staging:
    name: Deploy Staging (${{ matrix.cloud }})
    needs: [build-backend, provider]
    if: needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    environment: staging
    strategy:
      matrix:
        cloud: ${{ fromJson(needs.provider.outputs.backend_provider_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-backend
        with:
          cloud: ${{ matrix.cloud }}
          environment: staging
          image_tag: ${{ needs.build-backend.outputs.image_tag }}
          gcp_sa_key: ${{ secrets.GCP_SA_KEY }}
          gcp_project_id: ${{ secrets.GCP_PROJECT }}
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_project_id: ${{ secrets.SCW_PROJECT_ID }}
          scw_organization_id: ${{ secrets.SCW_ORGANIZATION_ID }}

  deploy-frontend-staging:
    name: Deploy Frontend (Staging)
    needs: [build-frontend, deploy-staging]
    if: needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontends

      - name: Install pnpm
        run: npm install -g pnpm

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-stg --project-name=hit8 --branch=main-staging

  # --------------------------------------------------------------------------
  # APPROVE PRODUCTION (single approval for backend + frontend)
  # --------------------------------------------------------------------------
  approve-production:
    name: Approve Production (Backend + Frontend)
    needs: [deploy-staging, deploy-frontend-staging]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Approved
        run: echo "Production deployment approved — backend and frontend will deploy"

  # --------------------------------------------------------------------------
  # DEPLOY PRODUCTION (runs in parallel after approval)
  # --------------------------------------------------------------------------
  deploy-production:
    name: Deploy Production (${{ matrix.cloud }})
    needs: [build-backend, approve-production, provider]
    if: needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cloud: ${{ fromJson(needs.provider.outputs.backend_provider_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/deploy-backend
        with:
          cloud: ${{ matrix.cloud }}
          environment: production
          image_tag: ${{ needs.build-backend.outputs.image_tag }}
          gcp_sa_key: ${{ secrets.GCP_SA_KEY }}
          gcp_project_id: ${{ secrets.GCP_PROJECT }}
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_project_id: ${{ secrets.SCW_PROJECT_ID }}
          scw_organization_id: ${{ secrets.SCW_ORGANIZATION_ID }}

  deploy-frontend-production:
    name: Deploy Frontend (Production)
    needs: [build-frontend, approve-production]
    if: needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontends

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Deploy iter8.hit8.io (production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_PAGES_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          packageManager: pnpm
          command: pages deploy dist-prd --project-name=hit8 --branch=main --commit-dirty=true

  # --------------------------------------------------------------------------
  # NOTIFY
  # --------------------------------------------------------------------------
  notify:
    name: Notify Deployment
    needs: [deploy-production, deploy-frontend-production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          B="${{ needs.deploy-production.result }}"
          F="${{ needs.deploy-frontend-production.result }}"
          if [ "$B" = "failure" ] || [ "$F" = "failure" ]; then
            echo "❌ Production deployment failed"
            echo "  Backend: $B | Frontend: $F"
            exit 1
          fi
          echo "✅ Production deployment ok (backend=$B frontend=$F)"
