substitutions:
  _PROXY_URL: 'http://10.0.0.2:3128'
  _SOCKS5_PROXY_IP: '10.0.0.2'
  _SOCKS5_PROXY_PORT: '1080'
  _IMAGE_NAME: 'europe-west1-docker.pkg.dev/${_PROJECT_ID}/backend/api'
  _TAG: 'latest'
  _SUPABASE_VERSION: '1.200.0' # Pin version for stability

steps:
  # ---------------------------------------------------------
  # Step 1: Database Migration (via SOCKS Tunnel)
  # ---------------------------------------------------------
  - name: 'debian:bookworm-slim'
    id: 'db-migration'
    entrypoint: 'bash'
    env:
      - 'PROXY_URL=${_PROXY_URL}'
      - 'SUPABASE_VERSION=${_SUPABASE_VERSION}'
      - 'SOCKS_IP=${_SOCKS5_PROXY_IP}'
      - 'SOCKS_PORT=${_SOCKS5_PROXY_PORT}'
    secretEnv: ['DOPPLER_SECRETS_JSON']
    args:
      - '-c'
      - |
        set -e
        export http_proxy=$$PROXY_URL
        export https_proxy=$$PROXY_URL

        echo "âš™ï¸  Installing migration tools..."
        # 1. Install minimal dependencies (No proxychains needed)
        # socat: creates the tunnel
        # nodejs: parses the secrets safely
        # curl & ca-certificates: downloads supabase
        apt-get update -qq && apt-get install -y -qq curl nodejs socat ca-certificates > /dev/null

        # 2. Download Supabase CLI (Direct Binary)
        curl -fSL "https://github.com/supabase/cli/releases/download/v$$SUPABASE_VERSION/supabase_linux_amd64.tar.gz" -o supabase.tar.gz
        tar -xzf supabase.tar.gz -C /usr/local/bin
        chmod +x /usr/local/bin/supabase
        rm supabase.tar.gz

        echo "ðŸ”§ Configuring Database Tunnel..."
        
        # 3. Parse Secrets & Prepare Tunnel
        # We use Node to split the DB URL into Host/Port and create a Localhost URL
        eval $(node -e '
          try {
            const secrets = JSON.parse(process.env.DOPPLER_SECRETS_JSON);
            const dbUrl = secrets.DIRECT_DB_CONNECTION_STRING;
            
            // Parse the remote URL
            // Format: postgres://user:pass@host:port/db
            // We need to extract the host/port to tell SOCAT where to tunnel
            const regex = /^(postgres(?:ql)?:\/\/[^@]+@)([^:\/]+)(?::(\d+))?(\/.*)$/;
            const match = dbUrl.match(regex);
            
            if (!match) throw new Error("Invalid DB URL format");

            const prefix = match[1];      // postgres://user:pass@
            const remoteHost = match[2];  // aws-1-eu-central-1...
            const remotePort = match[3] || "5432";
            const suffix = match[4];      // /postgres?options...

            // Construct the URL Supabase will use (pointing to localhost)
            const localUrl = `${prefix}127.0.0.1:5432${suffix}`;

            console.log(`export DB_REMOTE_HOST=${remoteHost}`);
            console.log(`export DB_REMOTE_PORT=${remotePort}`);
            console.log(`export LOCAL_DB_URL="${localUrl}"`);
          } catch(e) {
            console.error(e);
            process.exit(1);
          }
        ')

        # 4. Start Socat Tunnel
        # Listens on 127.0.0.1:5432 -> Tunnels via SOCKS -> To Remote DB
        socat TCP4-LISTEN:5432,fork,bind=127.0.0.1 SOCKS5:$$SOCKS_IP:$$DB_REMOTE_HOST:$$DB_REMOTE_PORT,socksport=$$SOCKS_PORT &
        SOCAT_PID=$!
        
        # Give the tunnel a moment to establish
        sleep 2

        echo "ðŸš€ Running migration..."
        # 5. Run Migration against Localhost (which tunnels to remote)
        /usr/local/bin/supabase db push --db-url "$$LOCAL_DB_URL"

        # Cleanup
        kill $SOCAT_PID

  # ---------------------------------------------------------
  # Step 2: Build and Push Docker Image
  # ---------------------------------------------------------
  - name: 'gcr.io/kaniko-project/executor:latest'
    id: 'build-image'
    waitFor: ['db-migration']
    args:
      - '--dockerfile=Dockerfile'
      - '--context=dir://./backend'
      - '--destination=${_IMAGE_NAME}:${_TAG}'
      - '--destination=${_IMAGE_NAME}:latest'
      - '--build-arg=PRODUCTION=true'
      - '--cache=true'
      - '--cache-ttl=24h'

availableSecrets:
  secretManager:
  - versionName: projects/${_PROJECT_ID}/secrets/doppler-hit8-prod/versions/latest
    env: 'DOPPLER_SECRETS_JSON'

options:
  pool:
    name: 'projects/${_PROJECT_ID}/locations/europe-west1/workerPools/private-pool-1'
