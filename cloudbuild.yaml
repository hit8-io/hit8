steps:
  # -------------------------------------------------------------------------
  # 1. Database Migration (Install CLI on the fly)
  # -------------------------------------------------------------------------
  - name: 'node:20-bullseye-slim'
    id: 'db-migration'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ Installing Supabase CLI..."
        npm install -g supabase
        
        echo "üöÄ Starting Supabase Migration..."
        if [ ! -d "supabase/migrations" ]; then
           echo "‚ö†Ô∏è  No 'supabase/migrations' folder found. Skipping."
           exit 0
        fi

        # Extract connection string from JSON secret
        DB_URL=$(node -e "console.log(JSON.parse(process.env.DOPPLER_SECRETS_JSON).DIRECT_DB_CONNECTION_STRING)")
        
        if [ -z "$DB_URL" ]; then
           echo "‚ùå Error: DIRECT_DB_CONNECTION_STRING not found in secrets."
           exit 1
        fi

        # Run migration
        supabase db push --db-url "$DB_URL"
    
    secretEnv: ['DOPPLER_SECRETS_JSON']

  # -------------------------------------------------------------------------
  # 2. Build and Push (Kaniko)
  # -------------------------------------------------------------------------
  - name: 'gcr.io/kaniko-project/executor:latest'
    id: 'build-image'
    waitFor: ['db-migration']
    args:
      - '--dockerfile=Dockerfile'
      - '--context=dir://./backend'
      - '--destination=${_IMAGE_NAME}:${_TAG}'
      - '--destination=${_IMAGE_NAME}:${_VERSION}'
      - '--destination=${_IMAGE_NAME}:latest'
      - '--build-arg=PRODUCTION=true'
      - '--cache=true'
      - '--cache-ttl=24h'
      - '--cache-repo=gcr.io/${_PROJECT_ID}/cache'

# Secrets Configuration
availableSecrets:
  secretManager:
  - versionName: projects/${_PROJECT_ID}/secrets/doppler-hit8-prod/versions/latest
    env: 'DOPPLER_SECRETS_JSON'

options:
  logging: CLOUD_LOGGING_ONLY
