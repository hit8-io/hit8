# Define variables so GCP accepts them from the command line/triggers
substitutions:
  _PROXY_URL: 'http://10.0.0.2:3128'
  _SOCKS5_PROXY: '10.0.0.2 1080' # Format: IP PORT (space separated for proxychains)
  _IMAGE_NAME: 'europe-west1-docker.pkg.dev/${_PROJECT_ID}/backend/api'
  _TAG: 'latest'
  _VERSION: 'unknown'
  _SUPABASE_VERSION: '1.200.0' # Pin version for stability

steps:
  # Database Migration
  - name: 'debian:bookworm-slim'
    id: 'db-migration'
    entrypoint: 'bash'
    env:
      - 'PROXY_URL=${_PROXY_URL}'
      - 'SOCKS5_PROXY=${_SOCKS5_PROXY}'
      - 'SUPABASE_VERSION=${_SUPABASE_VERSION}'
    secretEnv: ['DOPPLER_SECRETS_JSON']
    args:
      - '-c'
      - |
        set -e

        echo "âš™ï¸  Configuring environment..."
        export http_proxy=$$PROXY_URL
        export https_proxy=$$PROXY_URL
        
        # 1. Install dependencies
        # curl: to download supabase
        # nodejs: to parse secrets
        # proxychains4: to tunnel postgres traffic
        # ca-certificates: to verify SSL
        apt-get update -qq && apt-get install -y -qq curl nodejs proxychains4 ca-certificates > /dev/null

        # 2. Install Supabase CLI (Direct Download)
        echo "ðŸ“¥ Downloading Supabase CLI v$$SUPABASE_VERSION..."
        curl -fSL "https://github.com/supabase/cli/releases/download/v$$SUPABASE_VERSION/supabase_linux_amd64.tar.gz" -o supabase.tar.gz
        tar -xzf supabase.tar.gz -C /usr/local/bin
        chmod +x /usr/local/bin/supabase
        rm supabase.tar.gz

        # 3. Configure Proxychains
        echo -e "strict_chain\nproxy_dns\nremote_dns_subnet 224\ntcp_read_time_out 15000\ntcp_connect_time_out 8000\n[ProxyList]\nsocks5 $$SOCKS5_PROXY" > /etc/proxychains4.conf

        # 4. Extract Connection String from Secrets
        DB_URL=$(node -e 'try { console.log(JSON.parse(process.env.DOPPLER_SECRETS_JSON).DIRECT_DB_CONNECTION_STRING) } catch(e) { console.error("Secret parsing failed"); process.exit(1) }')

        # 5. Run Migration
        echo "ðŸš€ Running migration..."
        # Use explicit path and quiet mode for proxychains
        # Note: 'supabase db push' connects via TCP port 5432/6543, which proxychains will tunnel
        proxychains4 -q /usr/local/bin/supabase db push --db-url "$$DB_URL"

  # Build and Push Docker Image (Kaniko)
  - name: 'gcr.io/kaniko-project/executor:latest'
    id: 'build-image'
    waitFor: ['db-migration']
    args:
      - '--dockerfile=Dockerfile'
      - '--context=dir://./backend'
      - '--destination=${_IMAGE_NAME}:${_TAG}'
      - '--destination=${_IMAGE_NAME}:${_VERSION}'
      - '--destination=${_IMAGE_NAME}:latest'
      - '--build-arg=PRODUCTION=true'
      - '--cache=true'
      - '--cache-ttl=24h'

availableSecrets:
  secretManager:
  - versionName: projects/${_PROJECT_ID}/secrets/doppler-hit8-prod/versions/latest
    env: 'DOPPLER_SECRETS_JSON'

options:
  pool:
    name: 'projects/${_PROJECT_ID}/locations/europe-west1/workerPools/private-pool-1'
